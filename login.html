<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập | SAOVN Portal</title>
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <a href="index.html" class="login-logo">SAOVN</a>
            <h2>HỆ THỐNG ĐIỀU HÀNH</h2>
            <p>Vui lòng đăng nhập bằng tài khoản SAOVN</p>
            
            <form id="loginForm">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPass" placeholder="Mật khẩu" required>
                </div>
                <button type="submit" class="login-btn" id="btnLogin">XÁC MINH DANH TÍNH</button>
            </form>
            
           <div class="login-footer">
                <div class="footer-top">
                    <a href="#">Quên mật khẩu?</a>
                    <a href="register.html" style="color: var(--accent-color)">Tạo tài khoản mới</a>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        setPersistence, 
        browserLocalPersistence,
        signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // IMPORT THÊM CÁC HÀM CẦN THIẾT CHO TRANSACTION
    import { 
        getFirestore, doc, getDoc, runTransaction, increment 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBa3zOMwQr-KO77c5SsXEar8ycoRkmFbLk",
        authDomain: "saovn-project.firebaseapp.com",
        projectId: "saovn-project",
        storageBucket: "saovn-project.firebasestorage.app",
        messagingSenderId: "194928117396",
        appId: "1:194928117396:web:642612a60105add5639681",
        measurementId: "G-L7Y106VT85"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // HÀM XỬ LÝ TĂNG SỐ THÀNH VIÊN (+1)
    async function updateMemberCount(user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        // Kiểm tra nếu user đã xác minh email và chưa được đếm (isCounted === false)
        if (userSnap.exists() && userSnap.data().isCounted === false) {
            const statsRef = doc(db, "metadata", "users_stats");
            try {
                await runTransaction(db, async (transaction) => {
                    const statsDoc = await transaction.get(statsRef);
                    if (!statsDoc.exists()) {
                        transaction.set(statsRef, { totalMembers: 1 });
                    } else {
                        transaction.update(statsRef, { totalMembers: increment(1) });
                    }
                    // Đánh dấu đã đếm thành công để lần sau đăng nhập không +1 nữa
                    transaction.update(userRef, { isCounted: true });
                });
                console.log("Hệ thống: Đã xác nhận thành viên mới (+1)");
            } catch (e) {
                console.error("Lỗi cập nhật bộ đếm:", e);
            }
        }
    }

    // LOGIC ĐĂNG NHẬP
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        const btn = document.getElementById('btnLogin');

        try {
            btn.disabled = true;
            btn.innerText = "ĐANG XỬ LÝ...";

            await setPersistence(auth, browserLocalPersistence);
            const userCredential = await signInWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            await user.reload(); 
            
            if (user.emailVerified) {
                // THỰC HIỆN CỘNG SỐ THÀNH VIÊN TRƯỚC KHI VÀO TRANG CHỦ
                await updateMemberCount(user);
                window.location.href = "index.html"; 
            } else {
                alert("⚠️ Tài khoản chưa kích hoạt! Hãy kiểm tra Email của bạn.");
                await signOut(auth); 
                window.location.reload();
            }

        } catch (error) {
            alert("Lỗi: Email hoặc mật khẩu không chính xác.");
            btn.disabled = false;
            btn.innerText = "XÁC MINH DANH TÍNH";
        }
    });
</script>
</body>
</html>