<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt d·ª± √°n | SAOVN</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chi-tiet-du-an.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <style>
        /* ƒê·ªíNG B·ªò STYLE T·ª™ DU-AN.HTML */
        body { background-color: #0b0f19; color: #fff; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
        }

        .nav-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
            margin-right: 20px;
        }

        .user-profile {
            display: none;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 15px;
            border-radius: 30px;
            border: 1px solid #30363d;
        }

        .user-info-text {
            font-size: 0.85rem;
            color: #e6edf3;
        }

		.user-name {
			font-weight: 700;
			color: #00d2ff; /* M√†u xanh ƒë·∫∑c tr∆∞ng c·ªßa SAOVN */
			text-decoration: none;
			transition: 0.3s;
		}


		.user-name:hover {
			text-decoration: underline;
			color: #ffffff; /* Khi di chu·ªôt v√†o th√¨ hi·ªán m√†u tr·∫Øng cho n·ªïi b·∫≠t */
		}
		
        .btn-logout {
            background: transparent;
            border: 1px solid #ff3e3e;
            color: #ff3e3e;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: 0.3s;
        }

        .btn-logout:hover {
            background: #ff3e3e;
            color: #fff;
        }

        /* T·ªêI ∆ØU PH·∫¶N B√åNH LU·∫¨N */
        .comment-card {
            background: #161b22;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }

        .c-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .c-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .c-avatar-small {
            width: 35px;
            height: 35px;
            background: #30363d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff3e3e;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .c-actions {
            display: flex;
            gap: 12px;
            align-self: flex-end; 
            margin-top: 10px;
        }

        .btn-action {
            background: transparent;
            border: none;
            color: #8b949e;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            font-size: 0.75rem;
            padding: 5px;
        }

        .btn-action i {
            font-size: 0.85rem;
        }

        .btn-action:hover {
            color: #fff;
        }

        .btn-action.delete:hover {
            color: #f85149;
        }

        .c-text {
            color: #d1d5db;
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .btn-submit-comment {
            background-color: #ff3e3e !important;
            color: white !important;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            float: right;
            transition: 0.3s;
            letter-spacing: 1px;
        }

        .btn-submit-comment:hover {
            background-color: #ff5555 !important;
            transform: translateY(-2px);
        }

        .edit-area {
            width: 100%;
            background: #0d1117;
            color: #fff;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: inherit;
        }

        @media (max-width: 992px) {
            .nav-container { margin-right: 0; gap: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo-wrapper">
            <span class="logo-text">SAOVN</span>
            <span class="logo-slogan">Special Actions Organization for Vietnam</span>
        </a>
        
        <div class="menu-toggle" id="mobile-menu">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </div>

        <nav class="nav-container">
            <a href="index.html" class="nav-link">Trang ch·ªß</a>
            <a href="ve-saovn.html" class="nav-link">V·ªÅ SAOVN</a>
            <a href="du-an.html" class="nav-link active">D·ª± √°n</a>
            <a href="quy-tac.html" class="nav-link">Quy t·∫Øc</a>
            <a href="register.html" class="nav-link" id="nav-register">ƒêƒÉng k√Ω</a>
            <button class="btn-login" id="nav-login-btn" onclick="window.location.href='login.html'">ƒêƒÉng nh·∫≠p</button>
            
            <div class="user-profile" id="user-profile-box">
                <div class="user-info-text">
                    Ch√†o, <a href="dashboard.html" class="user-name" id="display-user-link">
                        <span id="display-user-name">ƒêang t·∫£i...</span>
                    </a>
                </div>
                <button class="btn-logout" id="auth-logout-btn">ƒêƒÉng xu·∫•t</button>
            </div>
        </nav>
    </header>

    <main id="main-content">
        <section class="about-hero-pro">
            <div class="container">
                <span class="sub-title" id="p-category-top" data-aos="fade-up">KHO L∆ØU TR·ªÆ H√ÄNH ƒê·ªòNG</span>
                <h1 id="p-title-top" data-aos="fade-up" data-aos-delay="200">
                    D·ª∞ √ÅN <span class="highlight">CHI·∫æN L∆Ø·ª¢C</span>
                </h1>
            </div>
        </section>

        <section class="main-project-container">
            <div class="p-content-card" data-aos="fade-up">
                <img id="p-thumbnail" src="" class="p-featured-img">
                <div class="meta-info" style="margin-bottom: 25px; display: flex; gap: 20px; color: #888;">
                    <span><i class="far fa-folder-open"></i> <b id="p-category-label" style="color:#ff3e3e"></b></span>
                    <span><i class="far fa-calendar-alt"></i> <span id="p-date"></span></span>
                </div>
                <div id="p-content" class="p-content-wrapper"></div>
            </div>
        </section>

        <section class="social-comment-section">
            <div class="container comment-box">
                <h2 style="margin-bottom: 30px; border-left: 4px solid #ff3e3e; padding-left: 15px; color: #fff; font-size: 1.2rem;">
                    TH·∫¢O LU·∫¨N (<span id="comment-count">0</span>)
                </h2>
                <div id="comment-form-area"></div>
                <div id="comment-list-container"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container footer-grid" data-aos="fade-up">
            <div class="footer-brand">
                <h3>SAOVN</h3>
                <p>Special Actions Organization for Vietnam</p>
                <p class="footer-slogan">S√°ng t·∫°o kh√¥ng gi·ªõi h·∫°n - N√¢ng t·∫ßm v·ªã th·∫ø Vi·ªát.</p>
            </div>
            <div class="footer-contact">
                <h4>Li√™n H·ªá</h4>
                <p>üìç Qu·∫≠n 1, TP. H·ªì Ch√≠ Minh, Vi·ªát Nam</p>
                <p>üìû 090 xxx xxxx | ‚úâÔ∏è contact@saovn.org</p>
            </div>
            <div class="footer-socials">
                <h4>K·∫øt N·ªëi</h4>
                <div class="social-icons">
                    <a href="#" class="social-link">TikTok</a>
                    <a href="#" class="social-link">YouTube</a>
                    <a href="#" class="social-link">Discord</a>
                    <a href="#" class="social-link">Facebook</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p class="copyright">&copy; 2026 SAOVN. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa3zOMwQr-KO77c5SsXEar8ycoRkmFbLk",
            authDomain: "saovn-project.firebaseapp.com",
            projectId: "saovn-project",
            storageBucket: "saovn-project.firebasestorage.app",
            messagingSenderId: "194928117396",
            appId: "1:194928117396:web:642612a60105add5639681"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        let currentUserData = null;

        onAuthStateChanged(auth, async (user) => {
            const upBox = document.getElementById('user-profile-box');
            const loginBtn = document.getElementById('nav-login-btn');
            const regLink = document.getElementById('nav-register');
            const nameDisp = document.getElementById('display-user-name');

            if (user) {
                upBox.style.display = 'flex';
                loginBtn.style.display = 'none';
                regLink.style.display = 'none';
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists()) {
                    currentUserData = { uid: user.uid, ...uDoc.data() };
                    nameDisp.innerText = currentUserData.fullName;
                }
            } else {
                upBox.style.display = 'none';
                loginBtn.style.display = 'block';
                regLink.style.display = 'block';
                currentUserData = null;
            }
            renderCommentForm();
            loadDetail();
            loadComments();
        });

        document.getElementById('auth-logout-btn').onclick = () => signOut(auth).then(() => window.location.reload());

        async function loadDetail() {
            if(!projectId) return;
            const snap = await getDoc(doc(db, "projects", projectId));
            if(snap.exists()) {
                const d = snap.data();
                document.getElementById('p-title-top').innerHTML = `${d.title.toUpperCase()} <span class="highlight">CHI·∫æN L∆Ø·ª¢C</span>`;
                document.getElementById('p-category-top').innerText = d.category.toUpperCase();
                document.getElementById('p-category-label').innerText = d.category;
                document.getElementById('p-thumbnail').src = d.thumbnail || 'https://via.placeholder.com/1200x600';
                document.getElementById('p-content').innerHTML = d.content;
                document.getElementById('p-date').innerText = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleDateString('vi-VN') : 'M·ªõi';
                AOS.init({ duration: 1000, once: true });
            }
        }

        function renderCommentForm() {
            const area = document.getElementById('comment-form-area');
            if(!currentUserData) {
                area.innerHTML = `<div style="text-align:center; color:#8b949e; padding:30px; border:1px dashed #30363d; border-radius:12px; margin-bottom:30px; background:#161b22;">H√£y <a href="login.html" style="color:#ff3e3e; font-weight:bold; text-decoration:none;">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ tham gia th·∫£o lu·∫≠n chi·∫øn l∆∞·ª£c.</div>`;
                return;
            }
            area.innerHTML = `
                <div class="comment-input-group" style="margin-bottom:40px;">
                    <textarea id="cm-input" class="edit-area" rows="3" placeholder="Nh·∫≠p √Ω ki·∫øn c·ªßa b·∫°n..."></textarea>
                    <button id="btn-post-cm" class="btn-submit-comment">G·ª¨I B√åNH LU·∫¨N</button>
                    <div style="clear:both"></div>
                </div>`;
            document.getElementById('btn-post-cm').onclick = async () => {
                const content = document.getElementById('cm-input').value.trim();
                if(!content) return;
                await addDoc(collection(db, "comments"), { 
                    projectId, 
                    userId: currentUserData.uid, 
                    userName: currentUserData.fullName, 
                    content, 
                    createdAt: serverTimestamp() 
                });
				await updateDoc(doc(db, "projects", projectId), {
					lastCommentAt: serverTimestamp(),
					lastCommentText: content 
				});
                document.getElementById('cm-input').value = "";
            };
        }

        function loadComments() {
            const q = query(collection(db, "comments"), where("projectId", "==", projectId), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('comment-list-container');
                document.getElementById('comment-count').innerText = snap.size;
                list.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    
                    // Ki·ªÉm tra quy·ªÅn: Admin ho·∫∑c ch·ªß s·ªü h·ªØu b√¨nh lu·∫≠n
                    const isOwner = currentUserData && currentUserData.uid === c.userId;
                    const isAdmin = currentUserData && currentUserData.role === 'admin';
                    
                    let actions = "";
                    if (isOwner) {
                        actions += `<button class="btn-action" onclick="toggleEdit('${d.id}')" title="S·ª≠a"><i class="fas fa-pen"></i> S·ª≠a</button>`;
                    }
                    if (isAdmin || isOwner) {
                        actions += `<button class="btn-action delete" onclick="deleteComment('${d.id}')" title="X√≥a"><i class="fas fa-trash-can"></i> X√≥a</button>`;
                    }

                    list.innerHTML += `
                        <div class="comment-card" id="card-${d.id}">
                            <div class="c-header">
                                <div class="c-user-info">
                                    <div class="c-avatar-small">${c.userName ? c.userName.charAt(0).toUpperCase() : '?'}</div>
                                    <span style="font-weight:600; color:#e6edf3;">${c.userName}</span>
                                </div>
                            </div>
                            <div id="text-${d.id}" class="c-text">${c.content}</div>
                            <div id="edit-box-${d.id}" style="display:none">
                                <textarea id="input-${d.id}" class="edit-area">${c.content}</textarea>
                                <div style="display:flex; gap:10px;">
                                    <button onclick="saveEdit('${d.id}')" style="background:#ff3e3e; color:#fff; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:600;">L∆∞u</button>
                                    <button onclick="toggleEdit('${d.id}')" style="background:transparent; color:#8b949e; border:1px solid #30363d; padding:6px 15px; border-radius:4px; cursor:pointer;">H·ªßy</button>
                                </div>
                            </div>
                            <div class="c-actions">${actions}</div>
                        </div>`;
                });
            });
        }

        window.deleteComment = async (id) => { 
            if(confirm("X√°c nh·∫≠n x√≥a b√¨nh lu·∫≠n n√†y?")) {
                await deleteDoc(doc(db, "comments", id)); 
            }
        };
        
        window.toggleEdit = (id) => {
            const box = document.getElementById(`edit-box-${id}`);
            const txt = document.getElementById(`text-${id}`);
            const act = document.querySelector(`#card-${id} .c-actions`);
            if(!box || !txt) return;

            const isEditing = box.style.display === 'block';
            
            box.style.display = isEditing ? 'none' : 'block';
            txt.style.display = isEditing ? 'block' : 'none';
            if(act) act.style.display = isEditing ? 'flex' : 'none';
        };

        window.saveEdit = async (id) => {
            const newContent = document.getElementById(`input-${id}`).value.trim();
            if(!newContent) return;
            try {
                await updateDoc(doc(db, "comments", id), { content: newContent });
                // onSnapshot s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·∫°i giao di·ªán, kh√¥ng c·∫ßn g·ªçi toggleEdit ·ªü ƒë√¢y
            } catch (e) {
                console.error("L·ªói c·∫≠p nh·∫≠t:", e);
                alert("L·ªói: Kh√¥ng th·ªÉ l∆∞u thay ƒë·ªïi.");
            }
        };

        document.querySelector('#mobile-menu').onclick = function() {
            this.classList.toggle('is-active');
            document.querySelector('.nav-container').classList.toggle('active');
        };
    </script>
</body>
</html>