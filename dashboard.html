<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SAOVN Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">
    <style>
        /* Màn hình chờ */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .loader {
            width: 40px; height: 40px; border: 3px solid #111;
            border-top: 3px solid #00d2ff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body.loaded { display: flex !important; }

        /* Role Badge Styles */
        #userRole {
            padding: 2px 12px; border-radius: 20px; font-size: 11px;
            font-weight: 600; border: 1px solid transparent;
            text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;
        }
        .role-admin { color: #ff4d4d; border-color: rgba(255, 77, 77, 0.4) !important; background: rgba(255, 77, 77, 0.05); }
        .role-mod { color: #adff2f; border-color: rgba(173, 255, 47, 0.4) !important; background: rgba(173, 255, 47, 0.05); }
        .role-member { color: #2ecc71; border-color: rgba(46, 204, 113, 0.4) !important; background: rgba(46, 204, 113, 0.05); }

        /* Modal Đổi Mật Khẩu */
        .modal {
            display:none; position: fixed; z-index: 10000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(5px); align-items: center; justify-content: center;
        }
        .modal-content {
            background: #111; padding: 40px; border-radius: 20px; 
            border: 1px solid #00d2ff; width: 90%; max-width: 400px; position: relative;
        }
        .modal-input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: #050505; 
            border: 1px solid #333; color: #fff; border-radius: 8px; outline: none;
        }
        .modal-input:focus { border-color: #00d2ff; }
    </style>
</head>
<body id="dashBody" style="display:none;">

    <div id="loading-screen">
        <div class="loader"></div>
        <p style="color: #00d2ff; font-family: sans-serif; letter-spacing: 2px; font-size: 12px;">ĐANG ĐỒNG BỘ DỮ LIỆU...</p>
    </div>

    <aside class="sidebar">
        <a href="index.html" class="sidebar-logo">SAOVN</a>
        <nav class="nav-menu">
    <a href="#" class="nav-item active"><i class="fas fa-th-large"></i> Tổng quan</a>
    <a href="#" class="nav-item"><i class="fas fa-project-diagram"></i> Dự án đang chạy</a>
    <a href="#" class="nav-item"><i class="fas fa-users"></i> Thành viên</a>
    
    <div class="nav-dropdown">
        <a href="javascript:void(0)" class="nav-item dropdown-toggle">
            <i class="fas fa-user-cog"></i> Tài khoản <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: auto;"></i>
        </a>
        <div class="sub-menu" id="accountSubMenu" style="display: none; padding-left: 30px;">
            <a href="#" class="nav-item" id="btnChangePassMenu" style="font-size: 14px;">
                <i class="fas fa-key"></i> Đổi mật khẩu
            </a>
        </div>
    </div>

    <a href="#" class="nav-item"><i class="fas fa-cog"></i> Cấu hình</a>
</nav>
        <button class="logout-btn" id="btnLogout"><i class="fas fa-sign-out-alt"></i> ĐĂNG XUẤT</button>
    </aside>

    <main class="main-content">
        <header class="top-bar">
			<button class="mobile-toggle" id="mobileToggle">
				<i class="fas fa-bars"></i>
			</button>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Tìm kiếm dữ liệu hệ thống...">
            </div>
            <div class="user-profile">
                <div class="user-info">
                    <span id="userName" class="name">Đang tải...</span>
                    <span id="userRole" class="role">Khách</span>
                </div>
                <div class="avatar" id="userAvatar">SV</div>
				<input type="file" id="avatarInput" accept="image/*">
            </div>
        </header>

        <div class="content-wrapper" style="padding: 30px;">
            <div class="welcome-section" style="margin-bottom: 40px;">
                <h1 style="font-size: 32px;">Chào mừng trở lại, <span id="welcomeName" style="color: #00d2ff;">Thành viên</span>!</h1>
                <p style="color: #888; margin-top: 10px;">Hệ thống SAOVN đã sẵn sàng cho các hành động mới của bạn.</p>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>Tổng thành viên</h3>
                    <div class="value" id="real-time-total-members">0</div>
                </div>
                <div class="stat-card"><h3>Tổng nhiệm vụ</h3><div class="value">124</div></div>
                <div class="stat-card"><h3>Thời gian hoạt động</h3><div class="value">48h</div></div>
            </div>

            <div class="chart-section" style="margin-top: 30px; display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
                <div class="chart-container" style="background: #111; padding: 25px; border-radius: 20px; height: 350px;">
                    <canvas id="statsChart"></canvas>
                </div>
                <div class="action-panel" style="background: #111; padding: 25px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px;">
                    <h3 style="margin-bottom: 10px; font-size: 16px;">Thao tác nhanh</h3>
                    
                    <button class="action-btn" style="width: 100%; padding: 12px; background: transparent; border: 1px solid #333; color: #fff; border-radius: 10px; cursor: pointer;">Xuất báo cáo</button>
                </div>
            </div>
        </div>
    </main>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" style="position: absolute; right: 20px; top: 15px; color: #555; cursor: pointer; font-size: 24px;">&times;</span>
            <h2 style="color: #00d2ff; margin-bottom: 20px; text-align: center;">ĐỔI MẬT KHẨU</h2>
            <form id="changePassForm">
                <input type="password" id="currentPass" class="modal-input" placeholder="Mật khẩu hiện tại" required>
                <input type="password" id="newPass" class="modal-input" placeholder="Mật khẩu mới" required>
                <input type="password" id="confirmNewPass" class="modal-input" placeholder="Xác nhận mật khẩu mới" required>
                <button type="submit" id="btnUpdatePass" style="width: 100%; padding: 12px; background: #00d2ff; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; color: #000;">CẬP NHẬT</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
// Thêm import Storage
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyBa3zOMwQr-KO77c5SsXEar8ycoRkmFbLk",
    authDomain: "saovn-project.firebaseapp.com",
    projectId: "saovn-project",
    storageBucket: "saovn-project.firebasestorage.app", // Đảm bảo bucket này chính xác
    messagingSenderId: "194928117396",
    appId: "1:194928117396:web:642612a60105add5639681",
    measurementId: "G-L7Y106VT85"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app); // Khởi tạo Storage

// --- CẬP NHẬT AVATAR ---
const avatarDiv = document.getElementById('userAvatar');
const avatarInput = document.getElementById('avatarInput');

// Khi click vào hình tròn avatar thì kích hoạt chọn file
avatarDiv.onclick = () => avatarInput.click();

avatarInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Kiểm tra định dạng và dung lượng (VD: < 2MB)
    if (file.size > 2 * 1024 * 1024) return alert("Ảnh quá lớn, vui lòng chọn ảnh < 2MB");

    const user = auth.currentUser;
    if (!user) return;

    try {
        avatarDiv.innerText = "..."; // Hiệu ứng đang tải
        
        // 1. Tải lên Storage
        const storageRef = ref(storage, `avatars/${user.uid}`);
        await uploadBytes(storageRef, file);
        
        // 2. Lấy URL ảnh
        const photoURL = await getDownloadURL(storageRef);
        
        // 3. Cập nhật Firestore
        await updateDoc(doc(db, "users", user.uid), {
            photoURL: photoURL
        });

        // 4. Hiển thị lên giao diện
        avatarDiv.innerText = "";
        avatarDiv.style.backgroundImage = `url('${photoURL}')`;
        alert("Cập nhật ảnh đại diện thành công!");

    } catch (error) {
        console.error("Lỗi upload:", error);
        alert("Có lỗi xảy ra khi tải ảnh lên.");
        avatarDiv.innerText = "SV";
    }
};

// --- AUTH & DATA (Giữ nguyên và bổ sung hiển thị ảnh) ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('userName').innerText = data.fullName || "User";
                document.getElementById('welcomeName').innerText = data.fullName || "User";
                
                // Hiển thị Avatar nếu có link ảnh
                if (data.photoURL) {
                    avatarDiv.innerText = "";
                    avatarDiv.style.backgroundImage = `url('${data.photoURL}')`;
                }

                const r = document.getElementById('userRole');
                if (data.role === 'admin') { r.innerText = 'Admin'; r.className = 'role role-admin'; }
                else if (data.role === 'mod') { r.innerText = 'Quản trị viên'; r.className = 'role role-mod'; }
                else { r.innerText = 'Thành viên'; r.className = 'role role-member'; }
            }
            
            // Lắng nghe stats thời gian thực
            onSnapshot(doc(db, "metadata", "users_stats"), s => {
                if (s.exists()) document.getElementById('real-time-total-members').innerText = s.data().totalMembers || 0;
            });

            document.body.classList.add('loaded');
            document.getElementById('dashBody').style.display = 'flex';
            document.getElementById('loading-screen').style.display = 'none';
            initChart();
        } catch (error) { console.error(error); }
    } else { window.location.href = "login.html"; }
});
		
		// Xử lý đóng/mở Sidebar trên Mobile
		const mobileToggle = document.getElementById('mobileToggle');
		const sidebar = document.querySelector('.sidebar');

		if (mobileToggle) {
			mobileToggle.addEventListener('click', (e) => {
				e.stopPropagation(); // Ngăn sự kiện bị gửi lên các phần tử cha
				sidebar.classList.toggle('active');
			});
		}

		// Click ra ngoài vùng Sidebar thì tự động đóng menu (tiện lợi cho mobile)
		document.addEventListener('click', (e) => {
			if (sidebar && sidebar.classList.contains('active')) {
				if (!sidebar.contains(e.target) && e.target !== mobileToggle) {
					sidebar.classList.remove('active');
				}
			}
		});

        // --- SESSION TIMEOUT (5 Phút) ---
        let idleTimeout;
        const resetTimer = () => {
            clearTimeout(idleTimeout);
            idleTimeout = setTimeout(() => { alert("Hết phiên làm việc!"); handleLogout(); }, 5 * 60 * 1000);
        };
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(e => document.addEventListener(e, resetTimer));

        async function handleLogout() {
            try { await signOut(auth); window.location.href = "login.html"; } catch (e) { console.error(e); }
        }

        // --- AUTH & DATA ---
		
		// --- LOGIC SUB-MENU TÀI KHOẢN ---
const dropdownToggle = document.querySelector('.dropdown-toggle');
const subMenu = document.getElementById('accountSubMenu');

if (dropdownToggle && subMenu) {
    dropdownToggle.addEventListener('click', (e) => {
        e.preventDefault();
        const isOpen = subMenu.style.display === 'block';
        
        // Đóng/mở menu con
        subMenu.style.display = isOpen ? 'none' : 'block';
        
        // Xoay mũi tên (cần class 'open' đã thêm ở CSS)
        dropdownToggle.classList.toggle('open');
    });
}
		
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                resetTimer();
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        document.getElementById('userName').innerText = data.fullName || "User";
                        document.getElementById('welcomeName').innerText = data.fullName || "User";
                        const r = document.getElementById('userRole');
                        if (data.role === 'admin') { r.innerText = 'Admin'; r.className = 'role role-admin'; }
                        else if (data.role === 'mod') { r.innerText = 'Quản trị viên'; r.className = 'role role-mod'; }
                        else { r.innerText = 'Thành viên'; r.className = 'role role-member'; }
                    }
                    onSnapshot(doc(db, "metadata", "users_stats"), s => {
                        if (s.exists()) document.getElementById('real-time-total-members').innerText = s.data().totalMembers || 0;
                    });
                    document.body.classList.add('loaded');
                    document.getElementById('dashBody').style.display = 'flex';
                    document.getElementById('loading-screen').style.display = 'none';
                    initChart();
                } catch (error) { console.error(error); }
            } else { window.location.href = "login.html"; }
        });

        // --- ĐỔI MẬT KHẨU ---
        const modal = document.getElementById("passwordModal");
        // Gán sự kiện cho nút Đổi mật khẩu trong menu mới
const btnInMenu = document.getElementById("btnChangePassMenu");
if (btnInMenu) {
    btnInMenu.onclick = (e) => {
        e.preventDefault();
        modal.style.display = "flex";
        
        // Nếu đang ở giao diện mobile, sau khi chọn thì đóng luôn Sidebar cho đỡ vướng
        if (window.innerWidth <= 768) {
            document.querySelector('.sidebar').classList.remove('active');
        }
    };
}
        document.getElementById("closeModal").onclick = () => modal.style.display = "none";
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

        document.getElementById("changePassForm").onsubmit = async (e) => {
            e.preventDefault();
            const curr = document.getElementById('currentPass').value;
            const next = document.getElementById('newPass').value;
            const conf = document.getElementById('confirmNewPass').value;
            if(next !== conf) return alert("Mật khẩu không khớp!");
            const btn = document.getElementById('btnUpdatePass');
            try {
                btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";
                const cred = EmailAuthProvider.credential(auth.currentUser.email, curr);
                await reauthenticateWithCredential(auth.currentUser, cred);
                await updatePassword(auth.currentUser, next);
                alert("Đổi mật khẩu thành công!"); modal.style.display = "none";
                document.getElementById("changePassForm").reset();
            } catch (err) { alert("Lỗi: " + err.message); }
            finally { btn.disabled = false; btn.innerText = "CẬP NHẬT"; }
        };

        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        function initChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['T3', 'T4', 'T5', 'T6'],
                    datasets: [{
                        label: 'Hoạt động',
                        data: [10, 25, 45, 30],
                        borderColor: '#00d2ff',
                        backgroundColor: 'rgba(0, 210, 255, 0.05)',
                        fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
