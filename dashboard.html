<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Trị | SAOVN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="display: none;">

    <div id="loading-screen"><div class="loader"></div><p style="margin-top:15px">HỆ THỐNG ĐANG TẢI...</p></div>

    <aside class="sidebar">
        <a href="index.html" class="sidebar-logo">SAOVN</a>
        <nav class="sidebar-menu">
            <a href="#" class="menu-item active" data-target="section-main"><i class="fas fa-th-large"></i> Tổng quan</a>
            <div class="menu-item-wrapper">
                <a href="#" class="menu-item" id="toggle-project-menu">
                    <i class="fas fa-tasks"></i> Quản lý dự án 
                    <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: auto;"></i>
                </a>
                <div class="submenu" id="project-submenu">
                    <a href="#" class="submenu-item" data-target="section-add-category">Thêm danh mục</a>
                    <a href="#" class="submenu-item" data-target="section-manage-category">Quản lý danh mục</a>
                    <a href="#" class="submenu-item" data-target="section-add-project">Thêm bài viết mới</a>
                    <a href="#" class="submenu-item" data-target="section-manage-project">Quản lý bài viết</a>
                </div>
            </div>
            <a href="#" class="menu-item" data-target="section-members"><i class="fas fa-users"></i> Thành viên</a>
            <a href="#" class="menu-item" data-target="section-messages"><i class="fas fa-envelope"></i> Tin nhắn</a>
            <a href="#" class="menu-item" id="btnOpenPass"><i class="fas fa-key"></i> Đổi mật khẩu</a>
            <div class="menu-item" id="btnLogout" style="margin-top:auto; color:#ff4444; cursor:pointer"><i class="fas fa-sign-out-alt"></i> Đăng xuất</div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <div><h2 id="welcome-text">Bảng Điều Khiển</h2><p id="nav-title" style="color:#888; font-size:14px">Tổng quan</p></div>
            <div class="user-profile">
                <div class="user-info"><span class="name" id="userNameDisplay">Admin</span><span class="role">Chỉ huy trưởng</span></div>
                <div class="avatar" id="userAvatar">A</div>
            </div>
        </header>

        <div id="section-main" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalMembers">0</div><div class="stat-label">Thành viên thực</div></div>
                <div class="stat-card"><div class="stat-value" id="totalProjectsCount">0</div><div class="stat-label">Tổng bài viết</div></div>
            </div>
            <div class="admin-card" style="margin-top:25px; height: 400px;">
                <h3><i class="fas fa-chart-line"></i> Phân tích lưu lượng</h3>
                <div style="height: 300px;"><canvas id="statsChart"></canvas></div>
            </div>
        </div>

        <div id="section-add-category" class="content-section">
            <div class="admin-card" style="max-width: 500px;">
                <h3><i class="fas fa-folder-plus"></i> Tạo danh mục mới</h3>
                <form id="category-form" style="margin-top: 20px;">
                    <input type="hidden" id="catId">
                    <div class="input-group-custom">
                        <label>Tên danh mục</label>
                        <input type="text" id="catName" class="input-control" placeholder="Ví dụ: Hoạt động xã hội..." required>
                    </div>
                    <button type="submit" class="login-btn" id="btnSaveCat">LƯU DANH MỤC</button>
                </form>
            </div>
        </div>

        <div id="section-manage-category" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-list"></i> Danh sách danh mục</h3>
                <div id="category-list" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>
            </div>
        </div>

        <div id="section-add-project" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-file-signature"></i> Soạn thảo nội dung dự án</h3>
                <form id="project-form" style="margin-top: 20px;">
                    <input type="hidden" id="projectId">
                    <div class="input-group-custom">
                        <label>Tiêu đề bài viết</label>
                        <input type="text" id="pTitle" class="input-control" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;" class="input-group-custom">
                        <div><label>Danh mục</label><select id="pCategory" class="input-control" required></select></div>
                        <div><label>Ảnh đại diện (Thumbnail)</label><input type="file" id="pThumbnail" class="input-control"></div>
                    </div>
                    
                    <div id="editor-container"></div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit" class="login-btn" id="btnSaveProject">XUẤT BẢN BÀI VIẾT</button>
                        <button type="button" id="btnCancelEdit" class="login-btn" style="background:#333; display:none;">HỦY CHỈNH SỬA</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="section-manage-project" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-copy"></i> Bài viết đã đăng</h3>
                <table class="project-table">
                    <thead><tr><th>Ảnh</th><th>Tiêu đề</th><th>Danh mục</th><th>Thao tác</th></tr></thead>
                    <tbody id="project-list"></tbody>
                </table>
            </div>
        </div>

        <div id="section-members" class="content-section"><div class="admin-card"><h3>Quản lý thành viên</h3></div></div>
        <div id="section-messages" class="content-section"><div class="admin-card"><h3>Hòm thư tin nhắn</h3></div></div>
    </main>

    <div id="passModal" class="modal">
        <div class="modal-content">
            <h3>ĐỔI MẬT KHẨU</h3>
            <form id="changePassForm" style="margin-top:20px">
                <input type="password" id="currPass" class="input-control" placeholder="Mật khẩu hiện tại" required style="margin-bottom:10px">
                <input type="password" id="nextPass" class="input-control" placeholder="Mật khẩu mới" required style="margin-bottom:10px">
                <input type="password" id="confirmPass" class="input-control" placeholder="Xác nhận mật khẩu mới" required style="margin-bottom:20px">
                <button type="submit" class="login-btn" style="width: 100%;">CẬP NHẬT</button>
                <button type="button" id="btnClosePass" style="width:100%; background:none; border:none; color:#555; margin-top:10px; cursor:pointer">Đóng</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa3zOMwQr-KO77c5SsXEar8ycoRkmFbLk",
            authDomain: "saovn-project.firebaseapp.com",
            projectId: "saovn-project",
            storageBucket: "saovn-project.firebasestorage.app",
            messagingSenderId: "194928117396",
            appId: "1:194928117396:web:642612a60105add5639681",
            measurementId: "G-L7Y106VT85"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- CẤU HÌNH QUILL EDITOR NÂNG CAO ---
        // Cấu hình toolbar đầy đủ chức năng
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'font': [] }],
            ['bold', 'italic', 'underline', 'strike'],        // định dạng chữ
            [{ 'color': [] }, { 'background': [] }],          // màu sắc
            [{ 'script': 'sub'}, { 'script': 'super' }],      // chỉ số trên/dưới
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],                                // CĂN LỀ
            ['link', 'image', 'video'],                       // media
            ['clean']                                         // xóa định dạng
        ];

        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions,
                imageResize: { // KÍCH THƯỚC ẢNH
                    modules: [ 'Resize', 'DisplaySize', 'Toolbar' ]
                }
            }
        });

        // Xử lý Upload ảnh lên Firebase trong trình soạn thảo
        quill.getModule('toolbar').addHandler('image', () => {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*'; input.click();
            input.onchange = async () => {
                const file = input.files[0];
                if(!file) return;
                const sRef = ref(storage, `content/${Date.now()}_${file.name}`);
                const snap = await uploadBytes(sRef, file);
                const url = await getDownloadURL(snap.ref);
                const range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', url);
            };
        });

        // --- NAVIGATION & FIREBASE LOGIC (Giữ nguyên từ bản trước) ---
        document.getElementById('toggle-project-menu').onclick = (e) => {
            e.preventDefault();
            document.getElementById('project-submenu').classList.toggle('show');
        };

        const navLinks = document.querySelectorAll('[data-target]');
        navLinks.forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const target = link.dataset.target;
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                document.querySelectorAll('.menu-item, .submenu-item').forEach(i => i.classList.remove('active'));
                link.classList.add('active');
                document.getElementById('nav-title').innerText = link.innerText.trim();
            };
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('userNameDisplay').innerText = userDoc.data().fullName;
                    document.getElementById('userAvatar').innerText = userDoc.data().fullName.charAt(0);
                    document.body.style.display = 'flex';
                    document.getElementById('loading-screen').style.display = 'none';
                    initChart();
                    loadData();
                } else { window.location.href = "login.html"; }
            } else { window.location.href = "login.html"; }
        });

        function loadData() {
            onSnapshot(collection(db, "users"), s => document.getElementById('totalMembers').innerText = s.size);
            onSnapshot(collection(db, "categories"), snap => {
                const list = document.getElementById('category-list');
                const select = document.getElementById('pCategory');
                list.innerHTML = ""; select.innerHTML = '<option value="">Chọn danh mục</option>';
                snap.forEach(d => {
                    const name = d.data().name;
                    list.innerHTML += `<div class="cat-item" style="background:#1a1a1a; padding:15px; border-radius:10px; border:1px solid #333; display:flex; justify-content:space-between;">
                        <span>${name}</span>
                        <div>
                            <i class="fas fa-edit" style="cursor:pointer; color:var(--accent-color)" onclick="editCat('${d.id}','${name}')"></i>
                            <i class="fas fa-trash" style="cursor:pointer; color:#ff4444; margin-left:15px" onclick="deleteCat('${d.id}')"></i>
                        </div>
                    </div>`;
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
            });
            onSnapshot(query(collection(db, "projects"), orderBy("createdAt", "desc")), snap => {
                const list = document.getElementById('project-list');
                list.innerHTML = "";
                document.getElementById('totalProjectsCount').innerText = snap.size;
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `<tr>
                        <td><img src="${p.thumbnail || ''}" width="50" style="border-radius:5px"></td>
                        <td>${p.title}</td>
                        <td><span style="color:#888; font-size:12px">${p.category}</span></td>
                        <td>
                            <i class="fas fa-edit" style="color:var(--accent-color); cursor:pointer" onclick="editProject('${d.id}')"></i>
                            <i class="fas fa-trash" style="color:#ff4444; cursor:pointer; margin-left:15px" onclick="deleteProject('${d.id}')"></i>
                        </td>
                    </tr>`;
                });
            });
        }

        window.editCat = (id, name) => {
            document.getElementById('catId').value = id;
            document.getElementById('catName').value = name;
            document.querySelector('[data-target="section-add-category"]').click();
        };
        window.deleteCat = async (id) => { if(confirm("Xóa danh mục này?")) await deleteDoc(doc(db, "categories", id)); };
        window.editProject = async (id) => {
            const d = await getDoc(doc(db, "projects", id));
            const data = d.data();
            document.getElementById('projectId').value = id;
            document.getElementById('pTitle').value = data.title;
            document.getElementById('pCategory').value = data.category;
            quill.root.innerHTML = data.content;
            document.getElementById('btnSaveProject').innerText = "CẬP NHẬT BÀI VIẾT";
            document.getElementById('btnCancelEdit').style.display = "block";
            document.querySelector('[data-target="section-add-project"]').click();
        };
        window.deleteProject = async (id) => { if(confirm("Xóa bài viết?")) await deleteDoc(doc(db, "projects", id)); };

        document.getElementById('category-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('catId').value;
            const name = document.getElementById('catName').value;
            if(id) await updateDoc(doc(db, "categories", id), { name });
            else await addDoc(collection(db, "categories"), { name });
            e.target.reset(); document.getElementById('catId').value = "";
            alert("Đã lưu danh mục!");
        };

        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveProject');
            btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";
            try {
                const id = document.getElementById('projectId').value;
                const file = document.getElementById('pThumbnail').files[0];
                let thumbUrl = null;
                if(file) {
                    const sRef = ref(storage, `thumbs/${Date.now()}_${file.name}`);
                    const snap = await uploadBytes(sRef, file);
                    thumbUrl = await getDownloadURL(snap.ref);
                }
                const data = {
                    title: document.getElementById('pTitle').value,
                    category: document.getElementById('pCategory').value,
                    content: quill.root.innerHTML,
                    updatedAt: serverTimestamp()
                };
                if(thumbUrl) data.thumbnail = thumbUrl;
                if(id) await updateDoc(doc(db, "projects", id), data);
                else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "projects"), data); }
                alert("Đã đăng bài thành công!");
                e.target.reset(); quill.setContents([]);
                document.getElementById('projectId').value = "";
                document.getElementById('btnCancelEdit').style.display = "none";
                btn.innerText = "XUẤT BẢN BÀI VIẾT";
            } catch (err) { alert(err.message); }
            finally { btn.disabled = false; }
        };

        function initChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['T2','T3','T4','T5','T6','T7','CN'],
                    datasets: [{ label: 'Lượt xem', data: [10, 45, 30, 70, 60, 90, 120], borderColor: '#00d2ff', tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        document.getElementById('btnOpenPass').onclick = () => document.getElementById('passModal').style.display='flex';
        document.getElementById('btnClosePass').onclick = () => document.getElementById('passModal').style.display='none';
        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>